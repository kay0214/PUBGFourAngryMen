<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>位置追踪1</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/player-list.css">
    <script src="js/lib/jquery-3.5.1.min.js"></script>
    <script src="js/lib/bootstrap.min.js"></script>
    <script src="js/util/MapConstant.js"></script>
    <script src="js/util/PubgMap.js"></script>
    <script src="js/util/TeamList.js"></script>

</head>
<body>
<div class="container-fluid testtest">

    <div class="row">
        <!--参数输入-->
        <form class="form-inline">
            <div class="form-group">
                <input type="text" class="form-control" id="matchIdInput1" placeholder="matchId">
            </div>
            <div class="btn btn-primary" id="btnGetTrack">load</div>
        </form>
    </div>

    <div class="row">
    </div>

    <div class="row">
        <div class="col-lg-4">
            <!--队伍列表-->
            <div id="teamList"></div>
        </div>

        <div class="col-lg-8">

            <input type="range" id="timeRange" min="0" max="1000" step="1">
            <!--地图-->
            <div id="pubgMap"></div>
        </div>
    </div>


</div>

</body>
<script>
    const pubgMap = new PubgMap("pubgMap", 800, 800);
    const teamList = new TeamList("teamList", true);

    const baseUrl = "/pubg";
    let trackData = {};
    let currentInstant = 0;

    teamList.onSelected(() => {
        drawInstantContent(currentInstant);
    })

    $("#timeRange").val(0).attr("disabled", "true");
    $("#btnGetTrack").click(() => {
        const matchId = $("#matchIdInput1").val();
        if (!matchId) {
            return;
        }

        $.ajax({
            url: baseUrl + "/position/track/" + matchId,
                success: (e) => {
                    console.log(e)
                    trackData = e;
                    $("#timeRange").attr("max", e.end).removeAttr("disabled");
                    //载入地图
                    pubgMap.setBackgroundMap(mapConstant.source[e.mapType], 800, 800);
                    //载入玩家列表
                    teamList.load(e.characters);
                }
            }
        )
    })

    $("#timeRange").on("input", (e) => {
        const current = e.target.value;
        currentInstant = current;
        drawInstantContent(current);
    })

    /**
     *
     * @param instant 时刻 拖动条的值
     */
    function drawInstantContent(instant) {
        let DRAW_NAME = true;
        pubgMap.clear();

        //遍历玩家
        for (let character of trackData.characters) {
            const accountId = character.accountId;

            //判断是否输出该角色
            if (!teamList.isSelected(accountId)) {
                continue;
            }

            let characterPos = trackData.positions[instant][accountId];
            //如果该时刻该角色存在位置信息
            if (characterPos) {
                const displayName = DRAW_NAME ? characterPos.name : "";
                pubgMap.drawPosition(characterPos.location.xratio, characterPos.location.yratio, characterPos.teamId, displayName);
            } else {
                //判断是否死亡
                const deathTime = trackData.deathLog[accountId];
                if (deathTime === undefined || deathTime > instant) {
                    //回溯时间查找
                    for (let past = instant - 1; past >= 0; past--) {
                        if (!trackData.positions[past]) {
                            continue;
                        }
                        characterPos = trackData.positions[past][accountId];
                        if (characterPos) {
                            const displayName = DRAW_NAME ? characterPos.name : "";
                            pubgMap.drawPosition(characterPos.location.xratio, characterPos.location.yratio, characterPos.teamId, displayName);
                            break;
                        }
                    }
                }

            }
        }


    }


</script>
<style>
    .testtest {
        border: solid red;
    }

    #timeRange {
        width: 800px;
    }

</style>
</html>